<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Characterizing mPOA cell-type heterogeneity with spatial bootstrapping • SEraster</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Characterizing mPOA cell-type heterogeneity with spatial bootstrapping">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SEraster</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.99.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/install.html">Install</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials">
<li><a class="dropdown-item" href="../articles/formatting-SpatialExperiment-for-SEraster.html">Formatting a SpatialExperiment Object for SEraster</a></li>
    <li><a class="dropdown-item" href="../articles/getting-started-with-SEraster.html">Getting Started With SEraster</a></li>
    <li><a class="dropdown-item" href="../articles/SEraster-for-SVG-analysis.html">SEraster for Spatial Variable Genes Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/characterizing-mPOA-cell-type-heterogeneity.html">Characterizing mPOA cell-type heterogeneity with spatial bootstrapping</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/JEFworks-Lab/SEraster/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Characterizing mPOA cell-type heterogeneity with spatial bootstrapping</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/JEFworks-Lab/SEraster/blob/HEAD/vignettes/characterizing-mPOA-cell-type-heterogeneity.Rmd" class="external-link"><code>vignettes/characterizing-mPOA-cell-type-heterogeneity.Rmd</code></a></small>
      <div class="d-none name"><code>characterizing-mPOA-cell-type-heterogeneity.Rmd</code></div>
    </div>

    
    
<p>In this tutorial, we will use <code>SEraster</code> to rasterize the
mouse medial preoptic region dataset assayed by MERFISH to demonstrate
how tissue section size affects cell-type proportions estimates.</p>
<div class="section level2">
<h2 id="load-libraries">Load libraries<a class="anchor" aria-label="anchor" href="#load-libraries"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/drighelli/SpatialExperiment" class="external-link">SpatialExperiment</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/JEFworks-Lab/SEraster" class="external-link">SEraster</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org" class="external-link">Matrix</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>One tissue sample of the MERFISH mPOA (bregma -0.29 slice from a
female naive animal) dataset is already formatted as a
<code>SpatialExperiment</code> object and is available in the
<code>SEraster</code> package. We will use this preprocessed dataset in
this tutorial (<a href="https://jef.works/%60SEraster%60/reference/merfish_mousePOA.html" class="external-link uri">https://jef.works/`SEraster`/reference/merfish_mousePOA.html</a>).</p>
</div>
<div class="section level2">
<h2 id="load-dataset">Load dataset<a class="anchor" aria-label="anchor" href="#load-dataset"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"merfish_mousePOA"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">merfish_mousePOA</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "SpatialExperiment"</span></span>
<span><span class="co">## attr(,"package")</span></span>
<span><span class="co">## [1] "SpatialExperiment"</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="visualize-cell-type-annotations">Visualize cell-type annotations<a class="anchor" aria-label="anchor" href="#visualize-cell-type-annotations"></a>
</h2>
<p>First, let’s grab the cell-type annotations from the
<code>SpatialExperiment</code> object.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ct</span> <span class="op">&lt;-</span> <span class="va">merfish_mousePOA</span><span class="op">$</span><span class="va">celltype</span>; <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ct</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">merfish_mousePOA</span><span class="op">)</span></span>
<span><span class="va">ct</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">ct</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ct</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ct</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">ct</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 6d6b1d59-6f3b-4a9d-b5a4-8c8b073ae025 76200644-c14a-4cfa-8752-2a02e5f10d20 </span></span>
<span><span class="co">##                          OD Mature 2                        OD Immature 1 </span></span>
<span><span class="co">## 6b08ca36-b395-415a-bb34-d7b67550c35d b9cb9cfb-fff7-426e-8c36-18fe428ca156 </span></span>
<span><span class="co">##                           Inhibitory                           Excitatory </span></span>
<span><span class="co">## 982cc0fc-6d11-4dc4-9ffc-c8c0cee48e6d ee13ce4c-adf8-4602-9a21-23fdf91d28e0 </span></span>
<span><span class="co">##                          OD Mature 2                           Inhibitory </span></span>
<span><span class="co">## 16 Levels: Ambiguous Astrocyte Endothelial 1 Endothelial 2 ... Pericytes</span></span>
<span><span class="co">## [1] 6509</span></span>
<span><span class="co">## [1] 16</span></span></code></pre>
<p>Next, we can use ggplot2 to visualize the cell-type annotations in
this tissue section of around 6500 cells comprising 16 cell-types.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SpatialExperiment/man/SpatialExperiment-methods.html" class="external-link">spatialCoords</a></span><span class="op">(</span><span class="va">merfish_mousePOA</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">pos</span>, ct <span class="op">=</span> <span class="va">ct</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">ct</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="characterizing-mPOA-cell-type-heterogeneity_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>To estimate the cell-type proportions in the whole tissue, we can
count the number of each cell-type, divide by the total number of cells
and multiply by 100. From this estimation, we see that approximately
30.9% of the cells are Inhibitory, 20.3% are Excitatory, 15.2% are
Ambigious, and so forth.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">globalEstimate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">ct</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ct</span><span class="op">)</span><span class="op">*</span><span class="fl">100</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">globalEstimate</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ct</span></span>
<span><span class="co">##    Inhibitory    Excitatory     Ambiguous     Astrocyte Endothelial 1 </span></span>
<span><span class="co">##   30.92640959   20.26424950   15.24043632   11.72223076    5.56153019 </span></span>
<span><span class="co">##   OD Mature 2 OD Immature 1     Ependymal     Microglia Endothelial 3 </span></span>
<span><span class="co">##    4.04055923    3.36457213    3.10339530    2.07405131    1.62851436 </span></span>
<span><span class="co">##     Pericytes   OD Mature 1 Endothelial 2   OD Mature 4   OD Mature 3 </span></span>
<span><span class="co">##    0.70671378    0.59917038    0.41481026    0.27654018    0.04609003 </span></span>
<span><span class="co">## OD Immature 2 </span></span>
<span><span class="co">##    0.03072669</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="use-seraster-to-create-spatial-bootstrap-samples">Use <code>SEraster</code> to create spatial bootstrap samples<a class="anchor" aria-label="anchor" href="#use-seraster-to-create-spatial-bootstrap-samples"></a>
</h2>
<p>To investigate a smaller section of the tissue, we can use
<code>SEraster</code> to aggregate cellular information into square or
hexagonal pixels at a resolution of your choosing and investigate the
cell-type proportions of each pixel.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/JEFworks-Lab/SEraster" class="external-link">SEraster</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## rasterize at 200um resolution with hexagons</span></span>
<span><span class="va">rastCt</span> <span class="op">&lt;-</span> <span class="fu">SEraster</span><span class="fu">::</span><span class="fu"><a href="../reference/rasterizeCellType.html">rasterizeCellType</a></span><span class="op">(</span><span class="va">merfish_mousePOA</span>,</span>
<span>                                      col_name <span class="op">=</span> <span class="st">"celltype"</span>,</span>
<span>                                      resolution <span class="op">=</span> <span class="fl">200</span>,</span>
<span>                                      fun <span class="op">=</span> <span class="st">"sum"</span>,</span>
<span>                                      square <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">## plot</span></span>
<span><span class="fu">SEraster</span><span class="fu">::</span><span class="fu"><a href="../reference/plotRaster.html">plotRaster</a></span><span class="op">(</span><span class="va">rastCt</span>, name <span class="op">=</span> <span class="st">"Total cells"</span><span class="op">)</span></span></code></pre></div>
<p><img src="characterizing-mPOA-cell-type-heterogeneity_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p><code>SEraster</code> keeps track of the number of cells in each of
these hexagonal pixels and the names of the cells per pixel.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">colData</span><span class="op">(</span><span class="va">rastCt</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## DataFrame with 6 rows and 6 columns</span></span>
<span><span class="co">##          num_cell</span></span>
<span><span class="co">##         &lt;integer&gt;</span></span>
<span><span class="co">## pixel11         1</span></span>
<span><span class="co">## pixel14         8</span></span>
<span><span class="co">## pixel15        32</span></span>
<span><span class="co">## pixel16        32</span></span>
<span><span class="co">## pixel17        40</span></span>
<span><span class="co">## pixel18        38</span></span>
<span><span class="co">##                                                                      cellID_list</span></span>
<span><span class="co">##                                                                           &lt;list&gt;</span></span>
<span><span class="co">## pixel11                                                   5ade45cb-f1de-45c1-9..</span></span>
<span><span class="co">## pixel14 6d6b1d59-6f3b-4a9d-b..,6b08ca36-b395-415a-b..,1baf79d2-f1b7-4a58-9..,...</span></span>
<span><span class="co">## pixel15 013f2667-a83f-44b9-a..,dfbf1f48-bdc3-41d8-9..,7320a328-21b2-4c7d-8..,...</span></span>
<span><span class="co">## pixel16 2ba4ad43-935e-4dc6-8..,423b0b5d-f22c-464e-a..,29bbf554-d2f2-4ae0-9..,...</span></span>
<span><span class="co">## pixel17 6612e339-aabd-4273-a..,ff72229c-5a4f-4dc4-b..,19ff3769-a405-4936-8..,...</span></span>
<span><span class="co">## pixel18 1f02025e-2a6d-4b80-9..,c753b3b2-c9aa-4f16-9..,65bc38da-8d3c-4633-8..,...</span></span>
<span><span class="co">##                type resolution               geometry   sample_id</span></span>
<span><span class="co">##         &lt;character&gt;  &lt;numeric&gt;          &lt;sfc_POLYGON&gt; &lt;character&gt;</span></span>
<span><span class="co">## pixel11     hexagon        200 list(c(-100, -200, -..    sample01</span></span>
<span><span class="co">## pixel14     hexagon        200 list(c(0, -100, -100..    sample01</span></span>
<span><span class="co">## pixel15     hexagon        200 list(c(0, -100, -100..    sample01</span></span>
<span><span class="co">## pixel16     hexagon        200 list(c(0, -100, -100..    sample01</span></span>
<span><span class="co">## pixel17     hexagon        200 list(c(0, -100, -100..    sample01</span></span>
<span><span class="co">## pixel18     hexagon        200 list(c(0, -100, -100..    sample01</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## check how many pixels were generated</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu">colData</span><span class="op">(</span><span class="va">rastCt</span><span class="op">)</span><span class="op">$</span><span class="va">cellID_list</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 109</span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## find the hexagonal pixel with the most number of cells</span></span>
<span><span class="va">maxCells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rastCt</span><span class="op">$</span><span class="va">num_cell</span><span class="op">)</span> <span class="co">## 102</span></span>
<span><span class="va">pixel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rastCt</span><span class="op">)</span><span class="op">[</span><span class="fu">colData</span><span class="op">(</span><span class="va">rastCt</span><span class="op">)</span><span class="op">$</span><span class="va">num_cell</span> <span class="op">==</span> <span class="va">maxCells</span><span class="op">]</span></span>
<span><span class="va">pixelIdx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rastCt</span><span class="op">)</span> <span class="op">==</span> <span class="va">pixel</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">pixel</span>, <span class="st">" at index "</span>, <span class="va">pixelIdx</span>, <span class="st">" has "</span>, <span class="va">maxCells</span>, <span class="st">" cells."</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "pixel75  at index  54  has  102  cells."</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## double check</span></span>
<span><span class="fu">colData</span><span class="op">(</span><span class="va">rastCt</span><span class="op">)</span><span class="op">[</span><span class="va">pixelIdx</span>,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## DataFrame with 1 row and 6 columns</span></span>
<span><span class="co">##          num_cell</span></span>
<span><span class="co">##         &lt;integer&gt;</span></span>
<span><span class="co">## pixel75       102</span></span>
<span><span class="co">##                                                                      cellID_list</span></span>
<span><span class="co">##                                                                           &lt;list&gt;</span></span>
<span><span class="co">## pixel75 1022d599-865f-4cf8-9..,c3f95685-61b7-4911-9..,d22dd31f-a6d7-437d-b..,...</span></span>
<span><span class="co">##                type resolution               geometry   sample_id</span></span>
<span><span class="co">##         &lt;character&gt;  &lt;numeric&gt;          &lt;sfc_POLYGON&gt; &lt;character&gt;</span></span>
<span><span class="co">## pixel75     hexagon        200 list(c(900, 800, 800..    sample01</span></span></code></pre>
<p>Now, let’s grab the cell-type annotations from the pixel with the
highest number of cells and plot the cell-types</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 54th pixel</span></span>
<span><span class="va">cells</span> <span class="op">&lt;-</span> <span class="fu">colData</span><span class="op">(</span><span class="va">rastCt</span><span class="op">)</span><span class="op">$</span><span class="va">cellID_list</span><span class="op">[[</span><span class="va">pixelIdx</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">## double check if the number of cells in this pixel matches maxCell</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">cells</span><span class="op">)</span> <span class="op">==</span> <span class="va">maxCells</span></span>
<span><span class="co">## visualize the cells in the 54th pixel</span></span>
<span><span class="va">dfsub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">pos</span><span class="op">[</span><span class="va">cells</span>,<span class="op">]</span>, ct <span class="op">=</span> <span class="va">ct</span><span class="op">[</span><span class="va">cells</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dfsub</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">ct</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="characterizing-mPOA-cell-type-heterogeneity_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>Once again, we can estimate the cell-type proportions. But this time,
in pixel 54.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pixelEstimate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">ct</span><span class="op">[</span><span class="va">cells</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ct</span><span class="op">[</span><span class="va">cells</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="fl">100</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">pixelEstimate</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##     Ependymal    Inhibitory    Excitatory     Ambiguous     Astrocyte </span></span>
<span><span class="co">##    33.3333333    26.4705882    21.5686275     8.8235294     4.9019608 </span></span>
<span><span class="co">## Endothelial 1 Endothelial 3 OD Immature 1 Endothelial 2     Microglia </span></span>
<span><span class="co">##     2.9411765     0.9803922     0.9803922     0.0000000     0.0000000 </span></span>
<span><span class="co">## OD Immature 2   OD Mature 1   OD Mature 2   OD Mature 3   OD Mature 4 </span></span>
<span><span class="co">##     0.0000000     0.0000000     0.0000000     0.0000000     0.0000000 </span></span>
<span><span class="co">##     Pericytes </span></span>
<span><span class="co">##     0.0000000</span></span></code></pre>
<p>We see that approximately 33.3% of the cells in this pixel are
Ependymal, 26.5% are Inhibitory, 21.6% are Excitatory, and so forth.
This section of the tissue has a relatively high proportion of Ependymal
cells compared to the whole tissue. Cell-type proportions for
Inhibitory, Excitatory, and Ambiguous are pretty high, consistent with
the whole tissue analysis we’ve done earlier.</p>
<p>Now let’s visualize where this pixel is located within the whole
tissue by isolating cells not contained in the hexagonal pixel 54.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctsub</span> <span class="op">&lt;-</span> <span class="va">ct</span></span>
<span><span class="va">ctsub</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ctsub</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">cells</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">pos</span>, ctsub <span class="op">=</span> <span class="va">ctsub</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">ctsub</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="characterizing-mPOA-cell-type-heterogeneity_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="evaluate-stability-of-cell-type-proportions">Evaluate stability of cell-type proportions<a class="anchor" aria-label="anchor" href="#evaluate-stability-of-cell-type-proportions"></a>
</h2>
<p>Let’s assess how good this pixel-based cell-type proportion
estimation is in each hexagonal pixel.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## grab list cell IDs for each hexagonal pixel</span></span>
<span><span class="va">cellidsPerBiopsy</span> <span class="op">&lt;-</span> <span class="fu">colData</span><span class="op">(</span><span class="va">rastCt</span><span class="op">)</span><span class="op">$</span><span class="va">cellID_list</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">cellidsPerBiopsy</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rastCt</span><span class="op">)</span></span>
<span><span class="co">## loop through and count number of each cell-type</span></span>
<span><span class="va">ctprop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">cellidsPerBiopsy</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">ct</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">ctprop</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">cellidsPerBiopsy</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ctprop</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         Ambiguous Astrocyte Endothelial 1 Endothelial 2 Endothelial 3 Ependymal</span></span>
<span><span class="co">## pixel11         0         0             0             0             0         0</span></span>
<span><span class="co">## pixel14         0         3             0             0             0         0</span></span>
<span><span class="co">## pixel15        10         3             4             0             0         0</span></span>
<span><span class="co">## pixel16         7         2             0             0             0         0</span></span>
<span><span class="co">## pixel17         8         1             3             0             0         0</span></span>
<span><span class="co">## pixel18         4         0             0             0             1         0</span></span>
<span><span class="co">##         Excitatory Inhibitory Microglia OD Immature 1 OD Immature 2 OD Mature 1</span></span>
<span><span class="co">## pixel11          0          0         0             0             0           0</span></span>
<span><span class="co">## pixel14          0          4         0             0             0           0</span></span>
<span><span class="co">## pixel15          6          7         0             1             0           0</span></span>
<span><span class="co">## pixel16         10          6         3             1             0           0</span></span>
<span><span class="co">## pixel17          2         16         2             2             0           1</span></span>
<span><span class="co">## pixel18          6         21         0             3             0           1</span></span>
<span><span class="co">##         OD Mature 2 OD Mature 3 OD Mature 4 Pericytes</span></span>
<span><span class="co">## pixel11           1           0           0         0</span></span>
<span><span class="co">## pixel14           1           0           0         0</span></span>
<span><span class="co">## pixel15           1           0           0         0</span></span>
<span><span class="co">## pixel16           3           0           0         0</span></span>
<span><span class="co">## pixel17           4           0           1         0</span></span>
<span><span class="co">## pixel18           2           0           0         0</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## divide by total cells per pixel</span></span>
<span><span class="co">## and multiple by 100 to make into percents</span></span>
<span><span class="va">ctpropNorm</span> <span class="op">&lt;-</span> <span class="va">ctprop</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">ctprop</span><span class="op">)</span><span class="op">*</span><span class="fl">100</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">ctpropNorm</span><span class="op">)</span><span class="op">)</span> <span class="co">## confirm sum is 100</span></span></code></pre></div>
<pre><code><span><span class="co">## pixel11 pixel14 pixel15 pixel16 pixel17 pixel18 </span></span>
<span><span class="co">##     100     100     100     100     100     100</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ctpropNorm</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         Ambiguous Astrocyte Endothelial 1 Endothelial 2 Endothelial 3 Ependymal</span></span>
<span><span class="co">## pixel11   0.00000     0.000           0.0             0      0.000000         0</span></span>
<span><span class="co">## pixel14   0.00000    37.500           0.0             0      0.000000         0</span></span>
<span><span class="co">## pixel15  31.25000     9.375          12.5             0      0.000000         0</span></span>
<span><span class="co">## pixel16  21.87500     6.250           0.0             0      0.000000         0</span></span>
<span><span class="co">## pixel17  20.00000     2.500           7.5             0      0.000000         0</span></span>
<span><span class="co">## pixel18  10.52632     0.000           0.0             0      2.631579         0</span></span>
<span><span class="co">##         Excitatory Inhibitory Microglia OD Immature 1 OD Immature 2 OD Mature 1</span></span>
<span><span class="co">## pixel11    0.00000    0.00000     0.000      0.000000             0    0.000000</span></span>
<span><span class="co">## pixel14    0.00000   50.00000     0.000      0.000000             0    0.000000</span></span>
<span><span class="co">## pixel15   18.75000   21.87500     0.000      3.125000             0    0.000000</span></span>
<span><span class="co">## pixel16   31.25000   18.75000     9.375      3.125000             0    0.000000</span></span>
<span><span class="co">## pixel17    5.00000   40.00000     5.000      5.000000             0    2.500000</span></span>
<span><span class="co">## pixel18   15.78947   55.26316     0.000      7.894737             0    2.631579</span></span>
<span><span class="co">##         OD Mature 2 OD Mature 3 OD Mature 4 Pericytes</span></span>
<span><span class="co">## pixel11  100.000000           0         0.0         0</span></span>
<span><span class="co">## pixel14   12.500000           0         0.0         0</span></span>
<span><span class="co">## pixel15    3.125000           0         0.0         0</span></span>
<span><span class="co">## pixel16    9.375000           0         0.0         0</span></span>
<span><span class="co">## pixel17   10.000000           0         2.5         0</span></span>
<span><span class="co">## pixel18    5.263158           0         0.0         0</span></span></code></pre>
<p>Let’s visualize the resulting cell-type proportions per hexagonal
pixel as a stacked barplot</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/reshape" class="external-link">reshape2</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Melt the data frame to long format</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">ctpropNorm</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">Sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="va">dfLong</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">df</span>, id.vars <span class="op">=</span> <span class="st">"Sample"</span>, variable.name <span class="op">=</span> <span class="st">"CellType"</span>, value.name <span class="op">=</span> <span class="st">"Proportion"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dfLong</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Sample  CellType Proportion</span></span>
<span><span class="co">## 1 pixel11 Ambiguous    0.00000</span></span>
<span><span class="co">## 2 pixel14 Ambiguous    0.00000</span></span>
<span><span class="co">## 3 pixel15 Ambiguous   31.25000</span></span>
<span><span class="co">## 4 pixel16 Ambiguous   21.87500</span></span>
<span><span class="co">## 5 pixel17 Ambiguous   20.00000</span></span>
<span><span class="co">## 6 pixel18 Ambiguous   10.52632</span></span></code></pre>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## create the stacked barplot using ggplot2</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dfLong</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Sample</span>, y <span class="op">=</span> <span class="va">Proportion</span>, fill <span class="op">=</span> <span class="va">CellType</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Stacked Barplot of Cell Type Proportions"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Sample"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Proportion"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, vjust <span class="op">=</span> <span class="fl">0.5</span>, hjust<span class="op">=</span><span class="fl">1</span>, size<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="characterizing-mPOA-cell-type-heterogeneity_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<p>Based on this visualization, we can observe that there is quite a lot
of variability in cell-type proportions across each pixel. Let’s find
which pixels are the most different from our global cell-type proportion
estimate.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">ctpropNorm</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">ctpropNorm</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">-</span><span class="va">globalEstimate</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">diff</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">ctpropNorm</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">diff</span>, decreasing<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   pixel11   pixel66  pixel111   pixel85  pixel124   pixel38 </span></span>
<span><span class="co">## 11004.924  8764.949  7760.186  5627.754  5627.754  4150.976</span></span></code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctpropNorm</span><span class="op">[</span><span class="st">'pixel11'</span>,<span class="op">]</span></span>
<span><span class="fu">colData</span><span class="op">(</span><span class="va">rastCt</span><span class="op">)</span><span class="op">[</span><span class="st">'pixel11'</span>,<span class="op">]</span><span class="op">$</span><span class="va">num_cell</span></span></code></pre></div>
<pre><code><span><span class="co">##     Ambiguous     Astrocyte Endothelial 1 Endothelial 2 Endothelial 3 </span></span>
<span><span class="co">##             0             0             0             0             0 </span></span>
<span><span class="co">##     Ependymal    Excitatory    Inhibitory     Microglia OD Immature 1 </span></span>
<span><span class="co">##             0             0             0             0             0 </span></span>
<span><span class="co">## OD Immature 2   OD Mature 1   OD Mature 2   OD Mature 3   OD Mature 4 </span></span>
<span><span class="co">##             0             0           100             0             0 </span></span>
<span><span class="co">##     Pericytes </span></span>
<span><span class="co">##             0 </span></span>
<span><span class="co">## [1] 1</span></span></code></pre>
<p>Notice there is only one cell contained in this pixel, and 100% of
the pixel of OD Mature 2 cell-type.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pixelIdx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rastCt</span><span class="op">)</span> <span class="op">==</span> <span class="st">'pixel11'</span><span class="op">)</span></span>
<span><span class="va">cells</span> <span class="op">&lt;-</span> <span class="fu">colData</span><span class="op">(</span><span class="va">rastCt</span><span class="op">)</span><span class="op">$</span><span class="va">cellID_list</span><span class="op">[[</span><span class="va">pixelIdx</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">## visualize the cells in the 54th pixel</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">pos</span><span class="op">[</span><span class="va">cells</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">cells</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">ct</span><span class="op">[</span><span class="va">cells</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="characterizing-mPOA-cell-type-heterogeneity_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## in whole tissue by setting cells not in hexagonal to NA</span></span>
<span><span class="va">ctsub</span> <span class="op">&lt;-</span> <span class="va">ct</span></span>
<span><span class="va">ctsub</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ctsub</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">cells</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">pos</span>, ctsub <span class="op">=</span> <span class="va">ctsub</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">ctsub</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="characterizing-mPOA-cell-type-heterogeneity_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
<p>Visually, this pixel is located at the edge of tissue and thus not
representative of the whole tissue.</p>
<p>Let’s see the distribution of the number of cells in each hexagonal
pixel.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## histogram of number of cells per pixel</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="fu">colData</span><span class="op">(</span><span class="va">rastCt</span><span class="op">)</span><span class="op">$</span><span class="va">num_cell</span><span class="op">)</span></span>
<span><span class="co">## we can set a threshold of only caring about pixels with more than 40 cells</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fl">40</span>, col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span></span></code></pre></div>
<p><img src="characterizing-mPOA-cell-type-heterogeneity_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## get pixels with more than 40 cells</span></span>
<span><span class="va">goodPixels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rastCt</span><span class="op">)</span><span class="op">[</span><span class="fu">colData</span><span class="op">(</span><span class="va">rastCt</span><span class="op">)</span><span class="op">$</span><span class="va">num_cell</span> <span class="op">&gt;</span> <span class="fl">40</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">goodPixels</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 82</span></span></code></pre>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">goodPixels</span><span class="op">)</span></span>
<span><span class="va">goodPixelIdx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">goodPixels</span>, <span class="kw">function</span><span class="op">(</span><span class="va">pixel</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rastCt</span><span class="op">)</span> <span class="op">==</span> <span class="va">pixel</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">goodPixelIdx</span><span class="op">)</span></span>
<span><span class="co">## double check</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rastCt</span><span class="op">)</span><span class="op">[</span><span class="fl">8</span><span class="op">]</span> <span class="op">==</span> <span class="st">"pixel21"</span> </span>
<span><span class="fu">`SEraster`</span><span class="fu">::</span><span class="fu">plotRaster</span><span class="op">(</span><span class="va">rastCt</span><span class="op">[</span>, <span class="va">goodPixelIdx</span><span class="op">]</span>, name <span class="op">=</span> <span class="st">"Total Cells"</span><span class="op">)</span></span></code></pre></div>
<p><img src="characterizing-mPOA-cell-type-heterogeneity_files/figure-html/unnamed-chunk-25-1.png" width="700"></p>
<pre><code><span><span class="co">## [1] "pixel21" "pixel22" "pixel23" "pixel24" "pixel25" "pixel28"</span></span>
<span><span class="co">## pixel21 pixel22 pixel23 pixel24 pixel25 pixel28 </span></span>
<span><span class="co">##       8       9      10      11      12      14 </span></span>
<span><span class="co">## [1] TRUE</span></span></code></pre>
<p>Now, let’s look at the cell-type proportions for the good pixels we
selected.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## just look at ctpropNorm for good pixels</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">ctpropNorm</span><span class="op">[</span><span class="va">goodPixelIdx</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">Sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="va">dfLong</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">df</span>, id.vars <span class="op">=</span> <span class="st">"Sample"</span>, variable.name <span class="op">=</span> <span class="st">"CellType"</span>, value.name <span class="op">=</span> <span class="st">"Proportion"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dfLong</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Sample</span>, y <span class="op">=</span> <span class="va">Proportion</span>, fill <span class="op">=</span> <span class="va">CellType</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Stacked Barplot of Cell Type Proportions"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Sample"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Proportion"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, vjust <span class="op">=</span> <span class="fl">0.5</span>, hjust<span class="op">=</span><span class="fl">1</span>, size<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="characterizing-mPOA-cell-type-heterogeneity_files/figure-html/unnamed-chunk-26-1.png" width="700"></p>
<p>Although better than the previous stacked barplot, there is still
some variability, mostly from the Ependymal, OD Mature 2, and Pericytes
cell-types. Let’s visualize them based on increasing proportion of each
cell-type.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ct.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Ependymal"</span>, <span class="st">"OD.Mature.2"</span>, <span class="st">"Pericytes"</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">ct</span> <span class="kw">in</span> <span class="va">ct.list</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">ctpropNorm</span><span class="op">[</span><span class="va">goodPixelIdx</span>,<span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">df</span><span class="op">$</span><span class="va">Sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span>  <span class="co">## let's create a separate data frame to visualize based on increasing proportion of cell type</span></span>
<span>  <span class="va">dfLong_ct</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">df</span>, id.vars <span class="op">=</span> <span class="st">"Sample"</span>, variable.name <span class="op">=</span> <span class="st">"CellType"</span>, value.name <span class="op">=</span> <span class="st">"Proportion"</span><span class="op">)</span></span>
<span>  <span class="co">## filter dfLong for based on cell type</span></span>
<span>  <span class="va">df_ct</span> <span class="op">&lt;-</span> <span class="va">dfLong_ct</span><span class="op">[</span><span class="va">dfLong_ct</span><span class="op">$</span><span class="va">CellType</span> <span class="op">==</span> <span class="va">ct</span>, <span class="op">]</span></span>
<span>  <span class="co">## order the pixels by increasing cell type proportions</span></span>
<span>  <span class="va">ordered_pixels</span> <span class="op">&lt;-</span> <span class="va">df_ct</span><span class="op">$</span><span class="va">Sample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">df_ct</span><span class="op">$</span><span class="va">Proportion</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="co">## convert the sample column to a factor in the with </span></span>
<span>  <span class="va">dfLong_ct</span><span class="op">$</span><span class="va">Sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">dfLong_ct</span><span class="op">$</span><span class="va">Sample</span>, levels <span class="op">=</span> <span class="va">ordered_pixels</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/methods/show.html" class="external-link">show</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dfLong_ct</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Sample</span>, y <span class="op">=</span> <span class="va">Proportion</span>, fill <span class="op">=</span> <span class="va">CellType</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Stacked Barplot Based on Increasing "</span>, <span class="va">ct</span>, <span class="st">" Proportion"</span><span class="op">)</span>,</span>
<span>         x <span class="op">=</span> <span class="st">"Sample"</span>,</span>
<span>         y <span class="op">=</span> <span class="st">"Proportion"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, vjust <span class="op">=</span> <span class="fl">0.5</span>, hjust<span class="op">=</span><span class="fl">1</span>, size<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="characterizing-mPOA-cell-type-heterogeneity_files/figure-html/unnamed-chunk-27-1.png" width="700"><img src="characterizing-mPOA-cell-type-heterogeneity_files/figure-html/unnamed-chunk-27-2.png" width="700"><img src="characterizing-mPOA-cell-type-heterogeneity_files/figure-html/unnamed-chunk-27-3.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="visualize-cell-type-specific-patterns">Visualize cell-type specific patterns<a class="anchor" aria-label="anchor" href="#visualize-cell-type-specific-patterns"></a>
</h2>
<p>The <code>plotRaster</code> function in <code>SEraster</code> allows
us to visualize the cell counts by specific cell-types. Let’s try and
visualize the spatial distribution of cell counts in these variable
cell-types.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ct.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Ependymal"</span>, <span class="st">"OD Mature 2"</span>, <span class="st">"Pericytes"</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">ct</span> <span class="kw">in</span> <span class="va">ct.list</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/methods/show.html" class="external-link">show</a></span><span class="op">(</span><span class="fu"><a href="../reference/plotRaster.html">plotRaster</a></span><span class="op">(</span><span class="va">rastCt</span>, plotTitle <span class="op">=</span> <span class="va">ct</span>, feature_name <span class="op">=</span> <span class="va">ct</span>, name <span class="op">=</span> <span class="st">"counts"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="characterizing-mPOA-cell-type-heterogeneity_files/figure-html/unnamed-chunk-28-1.png" width="700"><img src="characterizing-mPOA-cell-type-heterogeneity_files/figure-html/unnamed-chunk-28-2.png" width="700"><img src="characterizing-mPOA-cell-type-heterogeneity_files/figure-html/unnamed-chunk-28-3.png" width="700"></p>
<p>Indeed, we can see that these cell-types are expressed in a spatially
variable manner, meaning the pixels containing most of these cell-types
are generally not representative of the entire tissue.</p>
<p>This tutorial is adapted from the blog post “Characterizing spatial
heterogeneity using spatial bootstrapping with SEraster”. Find it here:
(<a href="https://jef.works/blog/2024/07/23/spatial-bootstrapping-with-seraster/" class="external-link uri">https://jef.works/blog/2024/07/23/spatial-bootstrapping-with-seraster/</a>)</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Gohta Aihara, Mayling Chen, Lyla Atta, Jean Fan.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
